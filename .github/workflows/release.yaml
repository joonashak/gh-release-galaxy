name: Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  # Simple sanity check before moving on with the release flow.
  check-tag:
    name: Check release tag
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.extract-version.outputs.version }}
    steps:
      - run: |
          echo "${GITHUB_REF}"
      - name: Check tag format and extract version
        id: extract-version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/*.*.* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
            echo "version=$VERSION" >> $GITHUB_ENV
          else
            echo "::error::Release tag is not valid."
            exit 1
          fi

  publish:
    name: Publish
    needs: check-tag
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Change to main branch
        run: |
          git fetch origin main:main
          git checkout main

      - name: Update Ansible Galaxy collection version
        run: |
          sed -i "s/^version: .*/version: ${{ needs.check-tag.outputs.version }}/" galaxy.yml

      - name: Commit galaxy.yml version update
        run: |
          git add galaxy.yml
          git commit -m "Update galaxy.yml version to $VERSION"
          git push --set-upstream origin main

      - name: Amend release tag to include previous commit
        run: |
          git tag -f "$GITHUB_REF_NAME"
          git push origin ":$GITHUB_REF"
          git push origin "$GITHUB_REF"
